<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Pac-Man</title>
    <style>
        /* CSS Styles */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000; /* Black background */
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive; /* Retro game font, will need to import */
            color: white;
            flex-direction: column;
            gap: 20px;
        }

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #score-panel {
            display: flex;
            justify-content: space-between;
            width: 100%; /* Will be adjusted by JS based on maze width */
            padding: 5px 0;
        }

        #game-board {
            display: grid;
            background-color: black;
            border: 4px solid blue; /* Border for the maze */
            position: relative;
            box-shadow: 0 0 30px rgba(0, 0, 255, 0.7);
        }

        .grid-cell {
            width: var(--cell-size); /* Defined by JS */
            height: var(--cell-size); /* Defined by JS */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wall {
            background-color: blue;
            border: 1px solid darkblue;
        }

        .dot {
            background-color: #EEE; /* White/off-white for dots */
            border-radius: 50%;
            width: 6px;
            height: 6px;
        }

        .power-pellet {
            background-color: orange;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: pulse 0.8s infinite alternate; /* Pulsing effect for power pellets */
        }

        @keyframes pulse {
            from { transform: scale(0.8); }
            to { transform: scale(1.2); }
        }

        #pacman {
            background-color: yellow;
            border-radius: 50%;
            width: var(--pacman-size); /* Defined by JS */
            height: var(--pacman-size); /* Defined by JS */
            position: absolute;
            transform: translate(-50%, -50%); /* Center the element */
            animation: chomping 0.2s infinite alternate;
            z-index: 10;
        }

        @keyframes chomping {
            0% { border-radius: 50% 50% 50% 50% / 50% 50% 50% 50%; }
            50% { border-radius: 50% 50% 0 50% / 50% 50% 0 50%; } /* Mouth open */
            100% { border-radius: 50% 50% 50% 50% / 50% 50% 50% 50%; }
        }

        .ghost {
            width: var(--ghost-size); /* Defined by JS */
            height: var(--ghost-size); /* Defined by JS */
            border-radius: 50% 50% 0 0; /* Ghost shape */
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 5;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden;
        }

        .ghost .eyes {
            width: 60%;
            height: 40%;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .ghost .eye {
            background-color: white;
            width: 40%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ghost .pupil {
            background-color: black;
            width: 50%;
            height: 50%;
            border-radius: 50%;
            position: relative;
        }

        .ghost.frightened {
            background-color: #3f51b5; /* Blue for frightened ghost */
            border-bottom-left-radius: 50%;
            border-bottom-right-radius: 50%;
            animation: frightened-blink 0.5s infinite alternate; /* Blink when time is running out */
        }

        @keyframes frightened-blink {
            0% { background-color: #3f51b5; }
            50% { background-color: white; } /* Alternates between blue and white */
            100% { background-color: #3f51b5; }
        }

        .ghost.frightened .eye { background-color: white; }
        .ghost.frightened .pupil { background-color: blue; }

        .ghost.eaten {
            background-color: transparent !important;
            border-radius: 0;
        }
        .ghost.eaten .eyes {
            width: 100%;
            height: 100%;
        }
        .ghost.eaten .eye {
            background-color: white;
            width: 40%;
            height: 40%;
            border-radius: 50%;
        }
        .ghost.eaten .pupil {
            background-color: black;
            width: 50%;
            height: 50%;
        }


        /* Ghost Colors */
        #blinky { background-color: red; }
        #pinky { background-color: pink; }
        #inky { background-color: cyan; }
        #clyde { background-color: orange; }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            font-size: 2em;
            text-align: center;
            z-index: 100;
        }

        #start-button {
            background-color: yellow;
            color: black;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            transition: background-color 0.2s;
        }

        #start-button:hover {
            background-color: #ffff00;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="score-panel">
            <div>Score: <span id="score">0</span></div>
            <div>Lives: <span id="lives">3</span></div>
        </div>
        <div id="game-board">
            <div id="pacman"></div>
            <div id="blinky" class="ghost"><div class="eyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div></div>
            <div id="pinky" class="ghost"><div class="eyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div></div>
            <div id="inky" class="ghost"><div class="eyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div></div>
            <div id="clyde" class="ghost"><div class="eyes"><div class="eye"><div class="pupil"></div></div><div class="eye"><div class="pupil"></div></div></div></div>
        </div>
        <div id="overlay">
            <h1>PAC-MAN</h1>
            <p>Use Arrow Keys to Move</p>
            <p id="game-message"></p>
            <button id="start-button">Start Game</button>
        </div>
    </div>

    <audio id="beginningSound" src="pacman_beginning.mp3"></audio>
    <audio id="chompSound" src="pacman_chomp.mp3"></audio>
    <audio id="deathSound" src="pacman_death.mp3"></audio>
    <audio id="eatGhostSound" src="pacman_eatghost.mp3"></audio>

    <script>
        // JavaScript Game Logic

        const gameBoard = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const pacmanElement = document.getElementById('pacman');
        const overlay = document.getElementById('overlay');
        const gameMessage = document.getElementById('game-message');
        const startButton = document.getElementById('start-button');

        // Audio elements
        const beginningSound = document.getElementById('beginningSound');
        const chompSound = document.getElementById('chompSound');
        const deathSound = document.getElementById('deathSound');
        const eatGhostSound = document.getElementById('eatGhostSound');

        // Game Constants
        const CELL_SIZE = 20; // Pixels per grid cell
        const PACMAN_SIZE = 18;
        const GHOST_SIZE = 18;
        const DOT_SCORE = 10;
        const POWER_PELLET_SCORE = 50;
        const GHOST_EAT_SCORE = 200;
        const FRIGHTENED_TIME = 8000; // 8 seconds
        const GHOST_SPEED = 150; // Milliseconds per move
        const PACMAN_SPEED = 150; // Milliseconds per move

        // Maze Definition (0=path, 1=wall, 2=dot, 3=power pellet, 4=empty path/ghost home)
        // This is a simplified version of the actual Pac-Man maze.
        const maze = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
            [1,3,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,3,1],
            [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1],
            [1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1],
            [1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,1,1,2,2,2,2,2,2,1],
            [1,1,1,1,1,1,2,1,1,1,1,1,0,0,0,0,1,1,1,1,1,2,1,1,1,1,1,1], /* Ghost Home */
            [1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,2,1,1,0,0,0,0,0,0,0,0,1,1,2,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
            [1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1],
            [1,3,2,2,2,2,2,2,2,2,2,2,2,4,4,2,2,2,2,2,2,2,2,2,2,2,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        let score = 0;
        let lives = 3;
        let dotsRemaining = 0;
        let gameRunning = false;
        let frightenedTimeout;
        let ghostRespawnTimeout;
        let pacmanDeathAnimationTimeout;

        // Cell dimensions for CSS variables
        document.documentElement.style.setProperty('--cell-size', `${CELL_SIZE}px`);
        document.documentElement.style.setProperty('--pacman-size', `${PACMAN_SIZE}px`);
        document.documentElement.style.setProperty('--ghost-size', `${GHOST_SIZE}px`);

        // Pac-Man state
        let pacman = {
            x: 1, // Column index
            y: 19, // Row index
            dx: 0, // direction X
            dy: 0, // direction Y
            nextDx: 0, // next desired direction X
            nextDy: 0, // next desired direction Y
            currentRotation: 0, // for pacman chomping direction
            isChomping: false,
            deathFrame: 0,
            isDead: false,
            speed: PACMAN_SPEED // ms per cell move
        };

        const ghosts = [
            { id: 'blinky', x: 13, y: 10, startX: 13, startY: 10, color: 'red', dx: -1, dy: 0, scared: false, eaten: false, speed: GHOST_SPEED },
            { id: 'pinky', x: 14, y: 10, startX: 14, startY: 10, color: 'pink', dx: 1, dy: 0, scared: false, eaten: false, speed: GHOST_SPEED },
            { id: 'inky', x: 12, y: 10, startX: 12, startY: 10, color: 'cyan', dx: 0, dy: 0, scared: false, eaten: false, speed: GHOST_SPEED },
            { id: 'clyde', x: 15, y: 10, startX: 15, startY: 10, color: 'orange', dx: 0, dy: 0, scared: false, eaten: false, speed: GHOST_SPEED }
        ];

        let pacmanMoveInterval;
        let ghostMoveIntervals = {};

        function initGame() {
            score = 0;
            lives = 3;
            dotsRemaining = 0;
            gameRunning = false;
            scoreDisplay.textContent = score;
            livesDisplay.textContent = lives;

            // Reset maze and pacman/ghost positions
            clearBoard();
            createGameBoard();
            resetPacman();
            resetGhosts();
            updatePacmanPosition(); // Initial render
            updateGhostPositions(); // Initial render
            hideGameElements();
            gameMessage.textContent = "Press START to begin!";
            overlay.classList.remove('hidden');
            startButton.textContent = "START GAME";
            startButton.onclick = startGame;

            // Stop any ongoing intervals
            clearInterval(pacmanMoveInterval);
            for (const ghost of ghosts) {
                clearInterval(ghostMoveIntervals[ghost.id]);
            }
            clearTimeout(frightenedTimeout);
            clearTimeout(ghostRespawnTimeout);
            clearTimeout(pacmanDeathAnimationTimeout);
        }

        function clearBoard() {
            while (gameBoard.firstChild) {
                gameBoard.removeChild(gameBoard.firstChild);
            }
        }

        function createGameBoard() {
            gameBoard.style.gridTemplateColumns = `repeat(${maze[0].length}, ${CELL_SIZE}px)`;
            gameBoard.style.gridTemplateRows = `repeat(${maze.length}, ${CELL_SIZE}px)`;
            gameBoard.style.width = `${maze[0].length * CELL_SIZE}px`;
            gameBoard.style.height = `${maze.length * CELL_SIZE}px`;

            // Adjust score panel width
            document.getElementById('score-panel').style.width = `${maze[0].length * CELL_SIZE}px`;

            dotsRemaining = 0; // Recalculate dots

            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    const div = document.createElement('div');
                    div.classList.add('grid-cell');
                    div.dataset.x = x;
                    div.dataset.y = y;

                    if (maze[y][x] === 1) {
                        div.classList.add('wall');
                    } else if (maze[y][x] === 2) {
                        const dot = document.createElement('div');
                        dot.classList.add('dot');
                        div.appendChild(dot);
                        dotsRemaining++;
                    } else if (maze[y][x] === 3) {
                        const powerPellet = document.createElement('div');
                        powerPellet.classList.add('power-pellet');
                        div.appendChild(powerPellet);
                        dotsRemaining++; // Power pellets also count towards dots
                    }
                    gameBoard.appendChild(div);
                }
            }
        }

        function getCell(x, y) {
            if (y < 0 || y >= maze.length || x < 0 || x >= maze[0].length) {
                return null; // Out of bounds
            }
            return document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
        }

        function getMazeValue(x, y) {
            if (y < 0 || y >= maze.length || x < 0 || x >= maze[0].length) {
                return 1; // Treat out of bounds as wall
            }
            return maze[y][x];
        }

        function resetPacman() {
            pacman.x = 1;
            pacman.y = 19;
            pacman.dx = 0;
            pacman.dy = 0;
            pacman.nextDx = 0;
            pacman.nextDy = 0;
            pacman.isChomping = false;
            pacman.isDead = false;
            pacmanElement.classList.remove('hidden');
            pacmanElement.style.transform = `translate(-50%, -50%) rotate(0deg)`; // Reset rotation
            pacmanElement.style.opacity = 1;
            pacmanElement.style.animation = 'chomping 0.2s infinite alternate';
        }

        function resetGhosts() {
            ghosts.forEach(ghost => {
                ghost.x = ghost.startX;
                ghost.y = ghost.startY;
                ghost.dx = ghost.id === 'blinky' ? -1 : 0; // Blinky moves left, others stay
                ghost.dy = ghost.id === 'blinky' ? 0 : 0;
                ghost.scared = false;
                ghost.eaten = false;
                const ghostEl = document.getElementById(ghost.id);
                ghostEl.classList.remove('frightened', 'eaten', 'hidden');
                ghostEl.style.opacity = 1;
            });
        }

        function hideGameElements() {
            pacmanElement.classList.add('hidden');
            ghosts.forEach(ghost => document.getElementById(ghost.id).classList.add('hidden'));
        }

        function showGameElements() {
             pacmanElement.classList.remove('hidden');
            ghosts.forEach(ghost => document.getElementById(ghost.id).classList.remove('hidden'));
        }


        function startGame() {
            if (gameRunning) return; // Prevent multiple starts

            overlay.classList.add('hidden');
            gameMessage.textContent = "";
            showGameElements();

            // Play beginning sound
            if (!beginningSound.paused) {
                beginningSound.pause();
                beginningSound.currentTime = 0;
            }
            beginningSound.play();

            // Wait for sound to finish before starting game loop
            beginningSound.onended = () => {
                gameRunning = true;
                clearInterval(pacmanMoveInterval);
                pacmanMoveInterval = setInterval(movePacman, pacman.speed);

                ghosts.forEach(ghost => {
                    clearInterval(ghostMoveIntervals[ghost.id]);
                    ghostMoveIntervals[ghost.id] = setInterval(() => moveGhost(ghost), ghost.speed);
                });

                document.addEventListener('keydown', handleKeydown);
            };
        }

        function gameOver(message) {
            gameRunning = false;
            clearInterval(pacmanMoveInterval);
            for (const ghost of ghosts) {
                clearInterval(ghostMoveIntervals[ghost.id]);
            }
            document.removeEventListener('keydown', handleKeydown);
            gameMessage.textContent = message;
            startButton.textContent = "PLAY AGAIN";
            startButton.onclick = initGame; // Restart game
            overlay.classList.remove('hidden');
            hideGameElements(); // Hide game elements on game over
        }

        function updatePacmanPosition() {
            pacmanElement.style.left = `${pacman.x * CELL_SIZE + CELL_SIZE / 2}px`;
            pacmanElement.style.top = `${pacman.y * CELL_SIZE + CELL_SIZE / 2}px`;
            // Update rotation based on direction
            if (pacman.dx === 1) pacman.currentRotation = 0; // Right
            else if (pacman.dx === -1) pacman.currentRotation = 180; // Left
            else if (pacman.dy === -1) pacman.currentRotation = -90; // Up
            else if (pacman.dy === 1) pacman.currentRotation = 90; // Down
            pacmanElement.style.transform = `translate(-50%, -50%) rotate(${pacman.currentRotation}deg)`;
        }

        function movePacman() {
            if (!gameRunning || pacman.isDead) return;

            let newX = pacman.x + pacman.nextDx;
            let newY = pacman.y + pacman.nextDy;

            // Check for valid move with next desired direction
            if (getMazeValue(newX, newY) !== 1) {
                pacman.dx = pacman.ne